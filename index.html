<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carnet Digital Club de Embarazadas HGSC</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f1f5f9; }
        
        /* Contenedor del Libro */
        .book-viewport {
            width: 100%;
            max-width: 380px;
            height: 680px;
            overflow: hidden;
            position: relative;
            background: white;
            border-radius: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            touch-action: pan-y;
        }
        .book-pages-container {
            display: flex;
            height: 100%;
            width: 100%;
            transition: transform 0.4s ease-out;
            will-change: transform;
        }
        .book-page {
            min-width: 100%;
            width: 100%;
            height: 100%;
            flex-shrink: 0;
            position: relative;
            overflow-y: auto;
            background: white;
        }
        .premium-border { border: 2px solid rgba(13, 148, 136, 0.1); }
        .rubrica-stamp {
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
            box-shadow: 0 4px 10px rgba(13, 148, 136, 0.3);
            border: 1px solid white;
        }
        .sync-ring {
            position: absolute;
            border: 2px solid #14b8a6;
            border-radius: 50%;
            animation: ripple 2s infinite;
            opacity: 0;
        }
        @keyframes ripple {
            0% { transform: scale(0.8); opacity: 0.8; }
            100% { transform: scale(3); opacity: 0; }
        }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .print-page { width: 100%; display: flex; flex-direction: row; page-break-after: always; }
            .print-half { width: 50%; padding: 20px; border: 1px solid #ccc; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, collection, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const { useState, useEffect, useRef } = React;

        // --- CONFIGURACI√ìN ---
        const firebaseConfig = {
            apiKey: "AIzaSyCMvahyS5wi58u_CKxSo8ZlVKNm_9nbQ2s", 
            authDomain: "club-embarazadas-hgsc.firebaseapp.com",
            projectId: "club-embarazadas-hgsc",
            storageBucket: "club-embarazadas-hgsc.firebasestorage.app",
            messagingSenderId: "896489048124",
            appId: "1:896489048124:web:80af9b046890005c6d1b39"
        };
        const APP_ID = 'club-embarazadas-hgsc-final';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- COMPONENTES ---
        const LogoSVG = ({ size }) => (
            <svg viewBox="0 0 100 100" className={size}><rect width="100" height="100" rx="30" fill="#0f172a"/><path d="M50 20 L50 80 M20 50 L80 50" stroke="#14b8a6" strokeWidth="8" opacity="0.2"/><path d="M35 40 C 35 30, 65 30, 65 50 C 65 70, 35 70, 35 85" stroke="white" strokeWidth="6" fill="none" strokeLinecap="round"/><circle cx="50" cy="55" r="14" fill="#fb7185"/><path d="M46 55 L49 58 L54 52" stroke="white" strokeWidth="3" fill="none"/></svg>
        );

        const HospitalLogo = ({ size }) => (
            <svg viewBox="0 0 100 100" className={size}><circle cx="50" cy="50" r="48" fill="#f8fafc" stroke="#0d9488" strokeWidth="2"/><path d="M30 50 L70 50 M50 30 L50 70" stroke="#0d9488" strokeWidth="12"/><circle cx="50" cy="50" r="10" fill="#ffffff"/></svg>
        );

        const RubricaIcon = ({ size }) => (
            <svg viewBox="0 0 100 100" className={size}>
                <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" strokeWidth="6" strokeDasharray="4 4" />
                <path d="M30 50 L45 65 L75 35" stroke="currentColor" strokeWidth="10" fill="none" strokeLinecap="round" />
            </svg>
        );

        const PhoneAvatar = ({ size }) => (
            <svg viewBox="0 0 100 100" className={size}>
                <circle cx="50" cy="50" r="45" fill="#fb7185" />
                <path d="M30,60 C30,30 70,30 70,60 C70,80 30,80 30,60" fill="#ffffff" />
                <circle cx="40" cy="55" r="5" fill="#fb7185" />
                <circle cx="60" cy="55" r="5" fill="#fb7185" />
                <path d="M45,70 Q50,75 55,70" stroke="#fb7185" strokeWidth="3" fill="none" strokeLinecap="round" />
                <path d="M65,30 L75,35 L75,45 C75,60 60,75 45,75" stroke="#ffffff" strokeWidth="4" fill="none" strokeLinecap="round" opacity="0.8" />
            </svg>
        );

        function SyncOverlay({ isVisible }) {
            if (!isVisible) return null;
            return (
                <div className="fixed inset-0 z-[1000] flex flex-col items-center justify-center bg-slate-900/95 backdrop-blur text-white text-center">
                    <div className="relative w-32 h-32 flex items-center justify-center">
                        <div className="sync-ring" style={{animationDelay: '0s'}}></div>
                        <div className="sync-ring" style={{animationDelay: '0.5s'}}></div>
                        <div className="z-10 bg-white p-4 rounded-full shadow-2xl text-teal-600">
                            <svg viewBox="0 0 24 24" className="w-12 h-12 animate-bounce" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 2v8m0 0l-3-3m3 3l3-3M5 12a7 7 0 0014 0m-2 4l2 2-2 2" strokeLinecap="round" strokeLinejoin="round"/></svg>
                        </div>
                    </div>
                    <h2 className="mt-8 font-black text-lg uppercase tracking-widest">SINCRO-NIZANDO...</h2>
                </div>
            );
        }

        function Modal({ isOpen, type, title, message, onClose }) {
            if (!isOpen) return null;
            const colors = type === 'error' ? 'bg-rose-600' : 'bg-teal-600';
            return (
                <div className="fixed inset-0 z-[2000] flex items-center justify-center p-6 bg-slate-950/80 backdrop-blur-sm">
                    <div className="bg-white rounded-[2.5rem] w-full max-w-sm overflow-hidden shadow-2xl animate-pop border-4 border-white font-black text-center">
                        <div className={`${type === 'error' ? 'bg-rose-50' : 'bg-teal-50'} p-10 flex flex-col items-center border-b`}>
                            <div className={`${colors} w-16 h-16 rounded-2xl flex items-center justify-center text-white text-3xl font-black mb-4 shadow-xl`}>
                                {type === 'error' ? '!' : '‚úì'}
                            </div>
                            <h3 className="text-xl font-black uppercase tracking-tighter">{title}</h3>
                        </div>
                        <div className="p-8 text-center bg-white font-bold">
                            <p className="text-slate-500 text-sm mb-8">{message}</p>
                            <button onClick={onClose} className={`${colors} w-full text-white font-black py-4 rounded-2xl uppercase text-[10px] tracking-widest`}>Entendido</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- VISTAS ---
        function LoginView({ ficha, setFicha, cod, setCod, onAccess, errorMsg }) {
            return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-slate-900 text-slate-800 font-bold">
                    <div className="bg-white p-10 rounded-[3.5rem] shadow-2xl w-full max-w-md text-center border-b-8 border-teal-600">
                        <LogoSVG size="w-24 h-24 mx-auto mb-8 shadow-xl" />
                        <h1 className="text-3xl uppercase tracking-tighter leading-none mb-1 font-black">Club de Embarazadas</h1>
                        <p className="text-teal-600 font-bold text-[10px] uppercase tracking-widest mb-10 italic border-y border-teal-50 py-2 inline-block px-4">Hospital Salina Cruz PEMEX</p>
                        <div className="space-y-6 text-left">
                            <div className="flex gap-4">
                                <div className="flex-grow">
                                    <label className="text-[9px] uppercase text-slate-400 mb-2 block tracking-widest">N√∫mero de Ficha</label>
                                    <input type="text" maxLength="6" placeholder="000000" className="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-3xl font-black text-xl outline-none focus:border-teal-500 shadow-inner" value={ficha} onChange={(e) => setFicha(e.target.value.replace(/\D/g,''))} />
                                </div>
                                <div className="w-24">
                                    <label className="text-[9px] uppercase text-slate-400 mb-2 block tracking-widest">COD</label>
                                    <select className="w-full p-4 bg-slate-900 text-white rounded-3xl font-black text-lg outline-none appearance-none cursor-pointer" value={cod} onChange={(e) => setCod(e.target.value)}><option value="08">08</option><option value="00">00</option></select>
                                </div>
                            </div>
                            {errorMsg && <p className="text-rose-600 text-xs font-black text-center">{errorMsg}</p>}
                            <button onClick={onAccess} className="w-full bg-teal-600 text-white font-black py-5 rounded-[2rem] shadow-xl hover:bg-teal-700 active:scale-95 text-xs uppercase tracking-[0.2em] mt-4">Abrir Carnet Digital</button>
                        </div>
                    </div>
                </div>
            );
        }

        function PatientBookView({ data, schedule, onBack, isAdmin = false, onPrint }) {
            const [page, setPage] = useState(0);
            const touchStartX = useRef(null);

            const next = () => { if (page < 2) setPage(page + 1); };
            const prev = () => { if (page > 0) setPage(page - 1); };

            const handleTouchStart = (e) => { touchStartX.current = e.touches[0].clientX; };
            const handleTouchEnd = (e) => {
                if (!touchStartX.current) return;
                const diff = touchStartX.current - e.changedTouches[0].clientX;
                if (diff > 50) next();
                if (diff < -50) prev();
                touchStartX.current = null;
            };

            return (
                <div className={isAdmin ? "" : "min-h-screen flex flex-col items-center justify-center p-4"}>
                    {!isAdmin && <button onClick={onBack} className="mb-4 bg-slate-800 text-white px-4 py-2 rounded-full text-xs uppercase font-bold">Cerrar Sesi√≥n</button>}
                    
                    <div className="book-viewport">
                        <div className="book-pages-container" 
                             style={{ transform: `translateX(-${page * 100}%)` }}
                             onTouchStart={handleTouchStart}
                             onTouchEnd={handleTouchEnd}>
                            
                            {/* P√ÅGINA 1: PORTADA */}
                            <div className="book-page p-8 flex flex-col text-center bg-slate-900 text-white">
                                <p className="text-[10px] uppercase tracking-widest text-teal-400 font-bold mb-2">Hospital General Salina Cruz</p>
                                <h2 className="text-2xl font-black mb-6">PEMEX</h2>
                                <div className="flex-grow flex flex-col items-center justify-center">
                                    <LogoSVG size="w-32 h-32 mb-6" />
                                    <h1 className="text-3xl font-black uppercase leading-none">Club de<br/>Embarazadas</h1>
                                    <div className="h-1 w-16 bg-rose-500 my-4 rounded-full"></div>
                                    <p className="text-xs uppercase tracking-widest opacity-70">Medicina Preventiva</p>
                                </div>
                                <div className="bg-white/10 p-4 rounded-2xl text-left mt-auto">
                                    <p className="text-[9px] uppercase opacity-60">Derechohabiente</p>
                                    <p className="font-bold text-sm uppercase truncate mb-2">{data?.nombre}</p>
                                    <div className="flex justify-between text-xs font-bold border-t border-white/10 pt-2">
                                        <span>Ficha: {data?.ficha}</span>
                                        <span className="text-rose-400">Sangre: {data?.sangre}</span>
                                    </div>
                                </div>
                            </div>

                            {/* P√ÅGINA 2: PROGRAMA */}
                            <div className="book-page p-6 bg-slate-50">
                                <div className="bg-rose-600 text-white p-4 rounded-xl mb-4 text-xs font-bold italic">
                                    ‚ö†Ô∏è SE√ëALES DE ALARMA: Dolor de cabeza, luces, zumbidos, hinchaz√≥n, sangrado.
                                </div>
                                <h3 className="text-slate-900 font-black text-sm uppercase mb-4 border-b-2 border-teal-500 pb-1">Pl√°ticas y Talleres</h3>
                                <div className="space-y-2">
                                    {schedule.map(s => (
                                        <div key={s.id} className="p-3 bg-white border rounded-xl flex items-center gap-3 shadow-sm">
                                            <div className="flex-grow min-w-0">
                                                <p className="text-[10px] font-black uppercase truncate">{s.tema}</p>
                                                <p className="text-[8px] text-teal-600 font-bold">{s.fecha} ‚Ä¢ {s.hora}</p>
                                            </div>
                                            {data?.asistencias?.[s.id] ? (
                                                <div className="w-8 h-8 rounded-full rubrica-stamp flex items-center justify-center text-white text-[10px] font-bold">‚úì</div>
                                            ) : (
                                                <div className="w-8 h-8 rounded-full border-2 border-dashed border-slate-200"></div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* P√ÅGINA 3: INFO */}
                            <div className="book-page p-8 flex flex-col justify-between text-center">
                                <div className="bg-slate-950 text-white p-6 rounded-3xl border-b-4 border-teal-500">
                                    <p className="text-2xl font-black mb-1">971-71-49000</p>
                                    <p className="text-[10px] uppercase font-bold text-teal-400">Extensi√≥n 52-414</p>
                                    <div className="mt-8">
                                        <HospitalLogo size="w-16 h-16 mx-auto mb-2" />
                                        <p className="text-[10px] font-black uppercase">Hospital Salina Cruz</p>
                                    </div>
                                </div>
                                <div className="text-[10px] font-bold text-slate-500 mt-4">
                                    <p>üìç Francisco Villa S/N, Col. Hidalgo Ote.</p>
                                    <p className="mt-4 text-teal-800 italic uppercase">"Mujer informada, embarazo seguro"</p>
                                </div>
                            </div>
                        </div>

                        {/* Controles de Navegaci√≥n */}
                        <div className="absolute bottom-4 left-0 right-0 flex justify-between px-6 items-center">
                            <button onClick={prev} className={`p-2 rounded-full bg-slate-100 ${page===0?'opacity-0':'opacity-100'}`}>‚ùÆ</button>
                            <div className="flex gap-1.5">
                                {[0,1,2].map(i => <div key={i} className={`w-2 h-2 rounded-full ${page===i?'bg-teal-600':'bg-slate-200'}`}></div>)}
                            </div>
                            <button onClick={next} className={`p-2 rounded-full bg-slate-100 ${page===2?'opacity-0':'opacity-100'}`}>‚ùØ</button>
                        </div>
                    </div>

                    {isAdmin && (
                        <div className="mt-4 flex gap-4">
                            <button onClick={() => onPrint(data)} className="bg-slate-950 text-white px-6 py-3 rounded-full text-xs font-black uppercase tracking-widest shadow-xl">Imprimir PDF</button>
                        </div>
                    )}
                </div>
            );
        }

        function AdminView({ adminName, schedule, patientsList, onUpdateSchedule, onSavePatient, onDeletePatient, onToggleRubrica, onBack, onPrint }) {
            const [tab, setTab] = useState('list');
            const [form, setForm] = useState({ ficha: '', cod: '08', nombre: '', fur: '', fpp: '', sangre: '', semanas: '', asistencias: {} });
            const [selected, setSelected] = useState(null);
            const [editMode, setEditMode] = useState(false);
            const [sched, setSched] = useState([...schedule]);

            useEffect(() => setSched([...schedule]), [schedule]);

            if (selected) return (
                <div className="p-6 max-w-lg mx-auto">
                    <button onClick={() => setSelected(null)} className="mb-4 text-slate-400 font-bold uppercase text-[10px]">‚Üê Volver</button>
                    <PatientBookView data={selected} schedule={schedule} isAdmin={true} onPrint={onPrint} />
                </div>
            );

            return (
                <div className="max-w-4xl mx-auto p-6">
                    <div className="flex justify-between items-center mb-8">
                        <div>
                            <h2 className="text-2xl font-black uppercase italic leading-none">PANEL DE CONTROL</h2>
                            <p className="text-teal-600 text-[10px] font-bold uppercase">{adminName}</p>
                        </div>
                        <button onClick={onBack} className="bg-rose-50 text-rose-600 px-4 py-2 rounded-xl text-xs font-bold">Cerrar</button>
                    </div>

                    <div className="flex bg-white p-1.5 rounded-2xl shadow-sm mb-8 gap-2 w-fit">
                        <button onClick={() => setTab('list')} className={`px-6 py-2 rounded-xl text-[10px] font-black uppercase ${tab === 'list' ? 'bg-slate-900 text-white' : 'text-slate-400'}`}>Lista</button>
                        <button onClick={() => { setEditMode(false); setForm({ ficha: '', cod: '08', nombre: '', fur: '', fpp: '', sangre: '', semanas: '', asistencias: {} }); setTab('new'); }} className={`px-6 py-2 rounded-xl text-[10px] font-black uppercase ${tab === 'new' ? 'bg-slate-900 text-white' : 'text-slate-400'}`}>Nueva</button>
                        <button onClick={() => setTab('global')} className={`px-6 py-2 rounded-xl text-[10px] font-black uppercase ${tab === 'global' ? 'bg-slate-900 text-white' : 'text-slate-400'}`}>Pl√°ticas</button>
                    </div>

                    {tab === 'new' && (
                        <div className="bg-white p-8 rounded-3xl shadow-xl space-y-4">
                            <input className="w-full p-4 bg-slate-50 border rounded-2xl font-bold" placeholder="Ficha" value={form.ficha} onChange={e => setForm({...form, ficha: e.target.value})} />
                            <input className="w-full p-4 bg-slate-50 border rounded-2xl font-bold" placeholder="Nombre Completo" value={form.nombre} onChange={e => setForm({...form, nombre: e.target.value.toUpperCase()})} />
                            <div className="grid grid-cols-2 gap-4">
                                <input className="p-4 bg-slate-50 border rounded-2xl font-bold" placeholder="FUR" value={form.fur} onChange={e => setForm({...form, fur: e.target.value})} />
                                <input className="p-4 bg-slate-50 border rounded-2xl font-bold" placeholder="FPP" value={form.fpp} onChange={e => setForm({...form, fpp: e.target.value})} />
                            </div>
                            <button onClick={async () => { const ok = await onSavePatient(form); if(ok) setTab('list'); }} className="w-full bg-teal-600 text-white font-black py-5 rounded-2xl uppercase tracking-widest shadow-lg">Guardar en la Nube</button>
                        </div>
                    )}

                    {tab === 'list' && (
                        <div className="space-y-3">
                            {patientsList.map(p => (
                                <div key={p.id} className="bg-white p-4 rounded-2xl flex items-center justify-between shadow-sm border border-slate-100">
                                    <div onClick={() => setSelected(p)} className="cursor-pointer">
                                        <p className="font-black text-sm text-slate-900">{p.nombre}</p>
                                        <p className="text-[10px] font-bold text-slate-400 uppercase">Ficha: {p.ficha}-{p.cod}</p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => { setForm(p); setEditMode(true); setTab('new'); }} className="p-2 bg-slate-100 rounded-lg">‚úèÔ∏è</button>
                                        <button onClick={() => onDeletePatient(p.id)} className="p-2 bg-rose-50 text-rose-500 rounded-lg">‚úï</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {tab === 'global' && (
                        <div className="bg-white p-6 rounded-3xl shadow-xl">
                            <h3 className="text-sm font-black mb-4 uppercase">PROGRAMA DE PL√ÅTICAS Y TALLERES</h3>
                            <div className="space-y-3">
                                {sched.map((s, i) => (
                                    <div key={s.id} className="p-3 bg-slate-50 rounded-xl border">
                                        <input className="w-full bg-transparent font-black text-xs uppercase mb-1 outline-none" value={s.tema} onChange={e => { const ns=[...sched]; ns[i].tema=e.target.value.toUpperCase(); setSched(ns); }} />
                                        <div className="flex gap-2">
                                            <input className="text-[10px] w-full p-2 bg-white rounded-lg" value={s.fecha} onChange={e => { const ns=[...sched]; ns[i].fecha=e.target.value; setSched(ns); }} />
                                            <input className="text-[10px] w-full p-2 bg-white rounded-lg" value={s.hora} onChange={e => { const ns=[...sched]; ns[i].hora=e.target.value; setSched(ns); }} />
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <button onClick={() => onUpdateSchedule(sched)} className="mt-6 w-full bg-slate-900 text-white font-black py-4 rounded-xl text-[10px] uppercase tracking-widest">Sincronizar Todos los Celulares</button>
                        </div>
                    )}
                </div>
            );
        }

        function PrintableContent({ data }) {
            if (!data) return null;
            return (
                <div className="print-page font-bold uppercase">
                    <div className="print-half">
                        <h3>Hospital General Salina Cruz - PEMEX</h3>
                        <p>Ficha: {data.ficha}</p>
                        <p>Nombre: {data.nombre}</p>
                    </div>
                    <div className="print-half">
                        <h3>Carnet Digital</h3>
                        <p>Medicina Preventiva</p>
                    </div>
                </div>
            );
        }

        // --- COMPONENTE APP PRINCIPAL ---
        function App() {
            const [view, setView] = useState('login');
            const [user, setUser] = useState(null);
            const [loginFicha, setLoginFicha] = useState('');
            const [loginCod, setLoginCod] = useState('08');
            const [loading, setLoading] = useState(true);
            const [isUpdating, setIsUpdating] = useState(false);
            const [globalSchedule, setGlobalSchedule] = useState([]);
            const [patientsList, setPatientsList] = useState([]);
            const [patientData, setPatientData] = useState(null);
            const [modal, setModal] = useState({ isOpen: false, type: 'success', title: '', message: '' });
            const [printData, setPrintData] = useState(null);
            const [loginError, setLoginError] = useState('');

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (u) => {
                    if (!u) {
                        try { await signInAnonymously(auth); } catch (e) { console.error(e); }
                    }
                    setUser(auth.currentUser);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubS = onSnapshot(doc(db, 'artifacts', APP_ID, 'public', 'data', 'config', 'schedule'), (snap) => {
                    if (snap.exists()) setGlobalSchedule(snap.data().platicas || []);
                });
                const unsubP = onSnapshot(collection(db, 'artifacts', APP_ID, 'public', 'data', 'patients'), (snap) => {
                    setPatientsList(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => { unsubS(); unsubP(); };
            }, [user]);

            useEffect(() => {
                if (printData) {
                    const timer = setTimeout(() => { window.print(); setPrintData(null); }, 1000);
                    return () => clearTimeout(timer);
                }
            }, [printData]);

            const handleAccess = async () => {
                const f = loginFicha.trim();
                if (!f) return;
                setLoading(true);
                setLoginError('');
                if (loginCod === '00' && (f === '464896' || f === '451977')) {
                    setView('admin');
                    setLoading(false);
                    return;
                }
                try {
                    const snap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'patients', `${f}-${loginCod}`));
                    if (snap.exists()) { setPatientData(snap.data()); setView('patient'); }
                    else { setLoginError('La ficha no est√° registrada.'); }
                } catch (err) { console.error(err); }
                setLoading(false);
            };

            const savePatient = async (data) => {
                if (!data.ficha || !data.nombre) return false;
                try {
                    await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'patients', `${data.ficha.trim()}-${data.cod}`), { ...data, updatedAt: new Date().toISOString() });
                    setModal({ isOpen: true, type: 'success', title: 'Sincronizado', message: 'Registro actualizado.' });
                    return true;
                } catch (e) { return false; }
            };

            const deletePatient = async (id) => {
                if (confirm("¬øEliminar permanentemente?")) await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'patients', id));
            };

            const updateGlobal = async (newList) => {
                setIsUpdating(true);
                try {
                    await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'config', 'schedule'), { platicas: newList });
                    setTimeout(() => { setIsUpdating(false); setModal({ isOpen: true, type: 'success', title: '√âxito', message: 'Programa actualizado globalmente.' }); }, 1500);
                } catch (e) { setIsUpdating(false); }
            };

            const toggleAsis = async (pId, sId) => {
                const p = patientsList.find(x => x.id === pId);
                const asis = { ...(p.asistencias || {}) };
                asis[sId] = !asis[sId];
                await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'patients', pId), { asistencias: asis });
            };

            if (loading) return <div className="h-screen bg-slate-900"></div>;

            return (
                <div className="min-h-screen">
                    <SyncOverlay isVisible={isUpdating} />
                    <Modal {...modal} onClose={() => setModal({...modal, isOpen: false})} />
                    {view === 'login' && <LoginView ficha={loginFicha} setFicha={setLoginFicha} cod={loginCod} setCod={setLoginCod} onAccess={handleAccess} errorMsg={loginError} />}
                    {view === 'patient' && <PatientBookView data={patientData} schedule={globalSchedule} onBack={() => setView('login')} />}
                    {view === 'admin' && <AdminView adminName="Trinidad Alejandra Ortiz" schedule={globalSchedule} patientsList={patientsList} onUpdateSchedule={updateGlobal} onSavePatient={savePatient} onDeletePatient={deletePatient} onToggleRubrica={toggleAsis} onBack={() => setView('login')} onPrint={setPrintData} />}
                    <div className="print-only"><PrintableContent data={printData} /></div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Carnet Digital Club de Embarazadas HGSC</title>
    
    <!-- Configuraci√≥n para App Nativa -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React y Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            overflow-x: hidden;
            background-color: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #0d9488; border-radius: 10px; }
        
        /* Contenedor del Libro Interactivo */
        .book-viewport {
            width: 100%;
            max-width: 400px;
            height: 700px;
            overflow: hidden;
            position: relative;
            background: white;
            border-radius: 2.5rem;
            box-shadow: 0 40px 80px -20px rgba(0,0,0,0.3);
            touch-action: pan-y;
        }
        .book-pages-container {
            display: flex;
            height: 100%;
            width: 100%;
            transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            will-change: transform;
        }
        .book-page {
            min-width: 100%;
            width: 100%;
            height: 100%;
            flex-shrink: 0;
            position: relative;
            background-color: white;
            overflow-y: auto;
        }
        
        .premium-border {
            border: 2px solid rgba(13, 148, 136, 0.15);
            outline: 6px solid white;
            outline-offset: -14px;
        }
        .spine-shadow { box-shadow: inset 15px 0 30px -15px rgba(0,0,0,0.1); }
        
        .rubrica-stamp {
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
            box-shadow: 0 4px 10px rgba(13, 148, 136, 0.3);
            border: 2px solid white;
        }

        .sync-ring {
            position: absolute;
            border: 3px solid #14b8a6;
            border-radius: 50%;
            animation: ripple 2s infinite;
            opacity: 0;
        }
        @keyframes ripple {
            0% { transform: scale(0.8); opacity: 0.8; }
            100% { transform: scale(3.5); opacity: 0; }
        }

        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media print {
            @page { size: letter landscape; margin: 0; }
            body { background: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .print-page { width: 11in; height: 8.5in; display: flex; flex-direction: row; page-break-after: always; background-color: white; }
            .print-half { width: 5.5in; height: 8.5in; padding: 0.4in; position: relative; }
            .print-border-frame { border: 3px solid #0d9488; height: 100%; width: 100%; padding: 20px; position: relative; box-sizing: border-box; display: flex; flex-direction: column; }
            .print-header-bar { background-color: #0d9488 !important; color: white !important; padding: 10px; text-align: center; font-weight: 900; text-transform: uppercase; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, collection, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCMvahyS5wi58u_CKxSo8ZlVKNm_9nbQ2s", 
            authDomain: "club-embarazadas-hgsc.firebaseapp.com",
            projectId: "club-embarazadas-hgsc",
            storageBucket: "club-embarazadas-hgsc.firebasestorage.app",
            messagingSenderId: "896489048124",
            appId: "1:896489048124:web:80af9b046890005c6d1b39"
        };
        const appInstance = initializeApp(firebaseConfig);
        const auth = getAuth(appInstance);
        const db = getFirestore(appInstance);
        const appId = 'club-embarazadas-hgsc-final';

        const { useState, useEffect, useRef } = React;

        // --- ASSETS ---
        const LogoSVG = ({ size }) => (
            <svg viewBox="0 0 100 100" className={size}>
                <rect width="100" height="100" rx="30" fill="#0f172a"/>
                <path d="M50 20 L50 80 M20 50 L80 50" stroke="#14b8a6" strokeWidth="8" opacity="0.2"/>
                <path d="M35 40 C 35 30, 65 30, 65 50 C 65 70, 35 70, 35 85" stroke="white" strokeWidth="6" fill="none" strokeLinecap="round"/>
                <circle cx="50" cy="55" r="14" fill="#fb7185" />
                <path d="M46 55 L49 58 L54 52" stroke="white" strokeWidth="3" fill="none" strokeLinecap="round"/>
            </svg>
        );

        const HospitalLogoSVG = ({ size }) => (
            <svg viewBox="0 0 100 100" className={size}>
                <circle cx="50" cy="50" r="48" fill="#f8fafc" stroke="#0d9488" strokeWidth="2" />
                <path d="M30 50 L70 50 M50 30 L50 70" stroke="#0d9488" strokeWidth="12" strokeLinecap="square" />
                <path d="M50 15 L50 85 M15 50 L85 50" stroke="#fb7185" strokeWidth="2" opacity="0.5" />
                <circle cx="50" cy="50" r="10" fill="#ffffff" />
                <path d="M45 50 L55 50 M50 45 L50 55" stroke="#0d9488" strokeWidth="3" />
            </svg>
        );

        const RubricaIcon = ({ size }) => (
            <svg viewBox="0 0 100 100" className={size}>
                <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" strokeWidth="6" strokeDasharray="4 4" />
                <path d="M30 50 L45 65 L75 35" stroke="currentColor" strokeWidth="10" fill="none" strokeLinecap="round" />
            </svg>
        );

        const PhoneAvatar = ({ size }) => (
            <svg viewBox="0 0 100 100" className={size}>
                <circle cx="50" cy="50" r="45" fill="#fb7185" />
                <path d="M30,60 C30,30 70,30 70,60 C70,80 30,80 30,60" fill="#ffffff" />
                <circle cx="40" cy="55" r="5" fill="#fb7185" /><circle cx="60" cy="55" r="5" fill="#fb7185" />
                <path d="M45,70 Q50,75 55,70" stroke="#fb7185" strokeWidth="3" fill="none" strokeLinecap="round" />
                <path d="M65,30 L75,35 L75,45 C75,60 60,75 45,75" stroke="#ffffff" strokeWidth="4" fill="none" strokeLinecap="round" opacity="0.8" />
            </svg>
        );

        // --- COMPONENTES AUXILIARES ---
        function SyncOverlay({ isVisible }) {
            if (!isVisible) return null;
            return (
                <div className="fixed inset-0 z-[1000] flex flex-col items-center justify-center bg-slate-900/95 backdrop-blur-md animate-fade-in text-white text-center">
                    <div className="relative w-48 h-48 flex items-center justify-center">
                        <div className="sync-ring" style={{animationDelay: '0s'}}></div>
                        <div className="sync-ring" style={{animationDelay: '0.5s'}}></div>
                        <div className="sync-ring" style={{animationDelay: '1s'}}></div>
                        <div className="z-10 bg-white p-6 rounded-full shadow-2xl text-teal-600">
                            <svg viewBox="0 0 24 24" className="w-16 h-16 animate-bounce" fill="none" stroke="currentColor" strokeWidth="2.5">
                                <path d="M12 2v8m0 0l-3-3m3 3l3-3M5 12a7 7 0 0014 0m-2 4l2 2-2 2" strokeLinecap="round" strokeLinejoin="round"/>
                            </svg>
                        </div>
                    </div>
                    <h2 className="mt-16 font-black text-xl uppercase tracking-widest px-10">Sincronizando...</h2>
                </div>
            );
        }

        function Modal({ isOpen, type, title, message, onClose }) {
            if (!isOpen) return null;
            const colors = type === 'error' ? 'bg-rose-600' : 'bg-teal-600';
            return (
                <div className="fixed inset-0 z-[600] flex items-center justify-center p-6 bg-slate-950/80 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white rounded-[2.5rem] w-full max-w-sm overflow-hidden shadow-2xl animate-pop border-4 border-white">
                        <div className={`${type === 'error' ? 'bg-rose-50' : 'bg-teal-50'} p-10 flex flex-col items-center border-b`}>
                            <div className={`${colors} w-16 h-16 rounded-2xl flex items-center justify-center text-white text-3xl font-black mb-4 shadow-xl`}>{type === 'error' ? '!' : '‚úì'}</div>
                            <h3 className="text-xl font-black uppercase text-center tracking-tighter">{title}</h3>
                        </div>
                        <div className="p-8 text-center bg-white font-bold">
                            <p className="text-slate-500 text-sm mb-8">{message}</p>
                            <button onClick={onClose} className={`${colors} w-full text-white font-black py-4 rounded-2xl uppercase text-[10px] tracking-widest`}>Entendido</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- VISTAS HIJAS ---
        function LoginView({ ficha, setFicha, cod, setCod, onAccess }) {
            return (
                <div className="min-h-screen flex items-center justify-center p-6 bg-slate-900 text-slate-800">
                    <div className="bg-white p-12 rounded-[4rem] shadow-2xl w-full max-w-md text-center border-b-8 border-teal-600">
                        <LogoSVG size="w-24 h-24 mx-auto mb-8 shadow-xl" />
                        <h1 className="text-3xl font-black uppercase mb-1">Club de Embarazadas</h1>
                        <p className="text-teal-600 font-bold text-[10px] uppercase tracking-widest mb-10 italic border-y border-teal-50 py-2 inline-block px-4">Hospital Salina Cruz PEMEX</p>
                        <div className="space-y-6 text-left">
                            <div className="flex gap-4">
                                <div className="flex-grow">
                                    <label className="text-[9px] uppercase text-slate-400 mb-2 block tracking-widest font-black">Ficha</label>
                                    <input type="text" maxLength="6" placeholder="000000" className="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-3xl font-black text-xl outline-none focus:border-teal-500" value={ficha} onChange={(e) => setFicha(e.target.value.replace(/\D/g,''))} />
                                </div>
                                <div className="w-24">
                                    <label className="text-[9px] uppercase text-slate-400 mb-2 block tracking-widest font-black">COD</label>
                                    <select className="w-full p-4 bg-slate-900 text-white rounded-3xl font-black text-lg outline-none appearance-none" value={cod} onChange={(e) => setCod(e.target.value)}><option value="08">08</option><option value="00">00</option></select>
                                </div>
                            </div>
                            <button onClick={onAccess} className="w-full bg-teal-600 text-white font-black py-5 rounded-[2rem] shadow-xl hover:bg-teal-700 active:scale-95 text-xs uppercase tracking-[0.2em] mt-4">Abrir Carnet</button>
                        </div>
                    </div>
                </div>
            );
        }

        function PatientBookView({ data, schedule, onBack, isAdmin = false, onPrint }) {
            const [page, setPage] = useState(0);
            const touchStartX = useRef(null);
            const onStart = (e) => touchStartX.current = e.touches[0].clientX;
            const onEnd = (e) => {
                if (!touchStartX.current) return;
                const diff = touchStartX.current - e.changedTouches[0].clientX;
                if (Math.abs(diff) > 40) {
                    if (diff > 0 && page < 2) setPage(p => p + 1);
                    if (diff < 0 && page > 0) setPage(p => p - 1);
                }
                touchStartX.current = null;
            };

            return (
                <div className={`${isAdmin ? '' : 'min-h-screen bg-slate-200 flex flex-col items-center justify-center p-4'}`}>
                    {!isAdmin && <button onClick={onBack} className="fixed top-6 right-6 z-[200] bg-slate-900 text-white px-6 py-3 rounded-full font-black text-[9px] uppercase tracking-widest shadow-xl">‚úï Salir</button>}
                    <div className={`book-viewport mx-auto ${isAdmin ? 'my-8' : ''}`}>
                        <div className="book-pages-container" style={{ transform: `translateX(-${page * 100}%)` }} onTouchStart={onStart} onTouchEnd={onEnd}>
                            <div className="book-page flex flex-col bg-gradient-to-br from-slate-900 via-slate-800 to-teal-900 text-white p-10 text-center premium-border font-black">
                                <div className="mb-8"><p className="text-[10px] uppercase opacity-80 italic">Hospital General Salina Cruz</p><h2 className="text-3xl font-black italic uppercase">PEMEX</h2></div>
                                <div className="flex-grow flex flex-col items-center justify-center"><LogoSVG size="w-32 h-32 mb-6 shadow-2xl" /><h1 className="text-4xl font-black uppercase leading-none mb-2">Club de<br/>Embarazadas</h1><div className="h-1.5 w-20 bg-rose-600 rounded-full mb-6"></div><p className="text-[10px] uppercase opacity-60 italic">Medicina Preventiva</p></div>
                                <div className="bg-white/5 p-6 rounded-[2.5rem] border border-white/10 text-left">
                                    <p className="text-[8px] opacity-50 uppercase mb-1">Derechohabiente</p>
                                    <p className="font-black text-sm uppercase truncate mb-3">{data?.nombre}</p>
                                    <div className="flex justify-between border-t border-white/10 pt-3">
                                        <div><p className="text-[8px] opacity-50 uppercase mb-1">Ficha</p><p className="text-xs font-black">{data?.ficha}-{data?.cod}</p></div>
                                        <div><p className="text-[8px] opacity-50 uppercase mb-1 text-right">Sangre</p><p className="text-xs font-black text-rose-500 text-right">{data?.sangre}</p></div>
                                    </div>
                                </div>
                            </div>
                            <div className="book-page p-8 bg-teal-50/50 spine-shadow premium-border font-black">
                                <div className="bg-rose-600 p-6 rounded-2xl text-white font-black mb-6">
                                    <h3 className="text-xs uppercase mb-3 italic flex items-center gap-2"><span className="w-2 h-2 bg-white rounded-full animate-ping"></span> Se√±ales de Alarma</h3>
                                    <div className="text-[9px] space-y-1.5 opacity-90 italic">
                                        <div>‚Ä¢ Dolor fuerte de cabeza</div><div>‚Ä¢ Luces o zumbido en o√≠dos</div><div>‚Ä¢ Hinchaz√≥n importante</div><div>‚Ä¢ Sangrado o salida l√≠quido</div>
                                    </div>
                                </div>
                                <h3 className="text-slate-900 font-black text-sm uppercase tracking-widest border-b-4 border-teal-100 pb-2 mb-4 italic">Programa Educativo</h3>
                                <div className="space-y-2.5">
                                    {schedule.map(s => (
                                        <div key={s.id} className="p-3 bg-white rounded-2xl border-2 border-slate-100 flex items-center gap-3 relative shadow-sm">
                                            <div className="flex-grow min-w-0 font-black"><p className="text-[10px] font-black uppercase truncate text-slate-800">{s.tema}</p><p className="text-[8px] font-bold text-teal-600 italic">{s.fecha} ‚Ä¢ {s.hora}</p></div>
                                            {data?.asistencias?.[s.id] && <div className="rubrica-stamp w-8 h-8 rounded-full flex items-center justify-center animate-pop"><RubricaIcon size="w-5 h-5 text-white" /></div>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="book-page p-10 flex flex-col justify-between text-center premium-border font-black">
                                <div className="bg-slate-950 p-8 rounded-[2.5rem] text-white border-b-8 border-teal-600">
                                    <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-xl"><PhoneAvatar size="w-12 h-12" /></div>
                                    <p className="text-2xl font-black mb-1">971-71-49000</p>
                                    <span className="bg-rose-600 px-4 py-1.5 rounded-full text-[9px] font-black uppercase italic">Ext. 52-414</span>
                                    <div className="mt-8 border-t border-white/10 pt-6"><HospitalLogoSVG size="w-14 h-14 mx-auto mb-3" /><p className="text-[10px] font-black uppercase">Hospital General Salina Cruz</p><p className="text-[7px] opacity-60 uppercase italic mt-1">Medicina Preventiva</p></div>
                                </div>
                                <div className="text-center pb-2">
                                    <p className="text-teal-600 text-[8px] font-black uppercase mb-1 italic">üìç Nuestra Ubicaci√≥n</p>
                                    <p className="text-[9px] font-bold text-slate-500 italic">Francisco Villa S/N, Col. Hidalgo Oriente, Salina Cruz, Oaxaca.</p>
                                    <div className="mt-6 pt-3 border-t text-[9px] font-black italic text-teal-800">"Mujer informada, embarazo seguro"</div>
                                </div>
                            </div>
                        </div>
                        <div className="p-6 bg-white border-t flex justify-between items-center font-black">
                            <button disabled={page === 0} onClick={() => setPage(p => p - 1)} className={`px-6 py-3 rounded-xl text-[8px] uppercase ${page === 0 ? 'text-slate-200' : 'bg-slate-100 hover:bg-slate-200'}`}>‚Üê Ant.</button>
                            <div className="flex gap-2">{[0,1,2].map(i => <div key={i} className={`h-1.5 rounded-full transition-all ${page === i ? 'w-6 bg-teal-600' : 'w-1.5 bg-slate-200'}`}></div>)}</div>
                            <button disabled={page === 2} onClick={() => setPage(p => p + 1)} className={`px-6 py-3 rounded-xl text-[8px] uppercase ${page === 2 ? 'text-slate-200' : 'bg-teal-600 text-white'}`}>Sig. ‚Üí</button>
                        </div>
                    </div>
                    {isAdmin && <div className="mt-6 flex justify-center no-print"><button onClick={() => onPrint(data)} className="bg-slate-950 text-white px-8 py-4 rounded-full font-black uppercase text-[10px] shadow-xl hover:bg-teal-800 transition-all flex items-center gap-4">üñ®Ô∏è Descargar en PDF</button></div>}
                </div>
            );
        }

        function AdminView({ adminName, schedule, patientsList, onUpdateSchedule, onSavePatient, onDeletePatient, onToggleRubrica, onBack, onPrint }) {
            const [tab, setTab] = useState('list');
            const [form, setForm] = useState({ ficha: '', cod: '08', nombre: '', fur: '', fpp: '', sangre: '', semanas: '', asistencias: {} });
            const [editMode, setEditMode] = useState(false);
            const [selectedPreview, setSelectedPreview] = useState(null);
            const [sched, setSched] = useState([...schedule]);

            useEffect(() => setSched([...schedule]), [schedule]);

            if (selectedPreview) return (
                <div className="max-w-4xl mx-auto p-10 animate-fade-in font-black">
                    <button onClick={() => setSelectedPreview(null)} className="mb-10 text-slate-400 font-black hover:text-slate-900 flex items-center gap-2">‚Üê Volver al Panel</button>
                    <PatientBookView data={selectedPreview} schedule={schedule} isAdmin={true} onPrint={onPrint} />
                </div>
            );

            return (
                <div className="max-w-6xl mx-auto p-6 md:p-12 font-black">
                    <header className="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
                        <div className="flex items-center gap-6 font-black"><LogoSVG size="w-20 h-20 shadow-xl" /><div className="font-black"><h2 className="text-3xl uppercase tracking-tighter italic">PANEL DE PL√ÅTICAS</h2><p className="text-teal-600 text-[10px] uppercase font-black">{adminName}</p></div></div>
                        <button onClick={onBack} className="bg-slate-900 text-white px-8 py-3 rounded-3xl font-black uppercase text-[10px]">Cerrar Sesi√≥n</button>
                    </header>
                    <div className="flex bg-white p-2 rounded-full shadow-md w-fit mb-12 gap-2 mx-auto md:mx-0 font-black">
                        <button onClick={() => setTab('list')} className={`px-8 py-2.5 rounded-full font-black uppercase text-[9px] ${tab === 'list' ? 'bg-slate-900 text-white shadow-xl' : 'text-slate-400'}`}>Integrantes</button>
                        <button onClick={() => { setEditMode(false); setForm({ ficha: '', cod: '08', nombre: '', fur: '', fpp: '', sangre: '', semanas: '', asistencias: {} }); setTab('new'); }} className={`px-8 py-2.5 rounded-full font-black uppercase text-[9px] ${tab === 'new' ? 'bg-slate-900 text-white shadow-xl' : 'text-slate-400'}`}>Alta/Editar</button>
                        <button onClick={() => setTab('global')} className={`px-8 py-2.5 rounded-full font-black uppercase text-[9px] ${tab === 'global' ? 'bg-slate-900 text-white shadow-xl' : 'text-slate-400'}`}>PL√ÅTICAS Y TALLERES</button>
                    </div>

                    {tab === 'new' && (
                        <div className="bg-white p-10 rounded-[3rem] shadow-xl space-y-8 animate-fade-in font-black">
                            <h3 className="text-2xl font-black uppercase italic border-b pb-4">{editMode ? 'Modificar Registro' : 'Nueva Derechohabiente'}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 italic font-black">
                                <div><label className="text-[10px] uppercase text-slate-400 block mb-2 font-black">Ficha PEMEX</label><div className="flex gap-4"><input disabled={editMode} className="flex-grow p-4 bg-slate-50 border-2 rounded-2xl font-black text-xl" placeholder="000000" value={form.ficha} onChange={e => setForm({...form, ficha: e.target.value.replace(/\D/g,'')})} /><select disabled={editMode} className="bg-slate-900 text-white rounded-2xl px-8 font-black" value={form.cod} onChange={e => setForm({...form, cod: e.target.value})}><option value="08">08</option><option value="00">00</option></select></div></div>
                                <div className="text-left font-black italic"><label className="text-[10px] uppercase text-slate-400 block mb-2">Nombre Completo</label><input className="w-full p-4 bg-slate-50 border-2 rounded-2xl font-black focus:border-teal-500 outline-none" value={form.nombre} onChange={e => setForm({...form, nombre: e.target.value.toUpperCase()})} /></div>
                                <div className="text-left font-black italic"><label className="text-[10px] uppercase text-slate-400 block mb-2">FUR</label><input className="w-full p-4 bg-slate-50 border-2 rounded-2xl font-black focus:border-teal-500 outline-none" value={form.fur} onChange={e => setForm({...form, fur: e.target.value})} /></div>
                                <div className="text-left font-black italic"><label className="text-[10px] uppercase text-slate-400 block mb-2">FPP</label><input className="w-full p-4 bg-slate-50 border-2 rounded-2xl font-black focus:border-teal-500 outline-none" value={form.fpp} onChange={e => setForm({...form, fpp: e.target.value})} /></div>
                                <div className="text-left font-black italic"><label className="text-[10px] uppercase text-slate-400 block mb-2">Sangre</label><input className="w-full p-4 bg-slate-50 border-2 rounded-2xl font-black focus:border-teal-500 outline-none" value={form.sangre} onChange={e => setForm({...form, sangre: e.target.value.toUpperCase()})} /></div>
                                <div className="text-left font-black italic"><label className="text-[10px] uppercase text-slate-400 block mb-2">Semanas</label><input className="w-full p-4 bg-slate-50 border-2 rounded-2xl font-black focus:border-teal-500 outline-none" value={form.semanas} onChange={e => setForm({...form, semanas: e.target.value})} /></div>
                            </div>
                            <button onClick={async () => { const ok = await onSavePatient(form); if (ok) setTab('list'); }} className="w-full bg-teal-600 text-white font-black py-6 rounded-2xl uppercase shadow-xl font-black">Sincronizar Datos</button>
                        </div>
                    )}

                    {tab === 'list' && (
                        <div className="bg-white p-10 rounded-[3rem] shadow-xl font-black animate-fade-in font-black">
                            <h3 className="text-2xl font-black uppercase italic border-b pb-8 mb-8 font-black font-black">Nube Digital PEMEX</h3>
                            <div className="overflow-x-auto"><table className="w-full text-left font-black"><thead><tr className="text-[10px] text-slate-400 border-b uppercase font-black font-black font-black"><th className="pb-6 px-4">FICHA</th><th className="pb-6 px-4 font-black font-black">NOMBRE</th><th className="pb-6 px-4 text-center font-black font-black">R√öBRICAS</th><th className="pb-6 px-4 text-right font-black font-black">ACCIONES</th></tr></thead><tbody className="text-xs font-bold divide-y font-black font-black font-black">
                                {patientsList.map(item => (
                                    <tr key={item.id} className="hover:bg-slate-50 transition-colors font-black">
                                        <td className="py-8 px-4 text-slate-400 font-black">{item.ficha}-{item.cod}</td>
                                        <td className="py-8 px-4 text-teal-800 uppercase font-black font-black">{item.nombre}</td>
                                        <td className="py-8 px-4 text-center">
                                            <div className="flex gap-1 justify-center font-black">
                                                {schedule.map(s => (
                                                    <button key={s.id} onClick={() => onToggleRubrica(item.id, s.id)} className={`w-4 h-4 rounded-full border ${item.asistencias?.[s.id] ? 'bg-teal-500 border-teal-500' : 'bg-slate-50'}`}></button>
                                                ))}
                                            </div>
                                        </td>
                                        <td className="py-8 px-4 text-right space-x-2 font-black font-black font-black">
                                            <button onClick={() => setSelectedPreview(item)} className="bg-teal-50 text-teal-700 px-3 py-1.5 rounded-lg text-[8px] uppercase font-black font-black">Ver</button>
                                            <button onClick={() => { setForm(item); setEditMode(true); setTab('new'); }} className="bg-slate-100 px-3 py-1.5 rounded-lg text-[8px] uppercase font-black">Edit</button>
                                            <button onClick={() => onDeletePatient(item.id)} className="bg-rose-50 text-rose-500 px-3 py-1.5 rounded-lg text-[8px] uppercase font-black font-black">X</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody></table></div>
                        </div>
                    )}

                    {tab === 'global' && (
                        <div className="bg-white p-10 rounded-[3rem] shadow-xl font-black animate-fade-in font-black">
                            <h3 className="text-2xl font-black uppercase italic border-b pb-8 mb-10 leading-none font-black font-black">PROGRAMA DE PL√ÅTICAS Y TALLERES DE MEDICINA PREVENTIVA DE HGSC</h3>
                            <div className="space-y-4 font-black">
                                {sched.map((s, i) => (
                                    <div key={s.id} className="grid grid-cols-1 md:grid-cols-6 gap-6 p-6 bg-slate-50 rounded-[2.5rem] border font-black font-black">
                                        <div className="md:col-span-2 italic font-black font-black"><label className="text-[8px] uppercase text-teal-600 block mb-1 font-black">Tema</label><input className="w-full p-4 rounded-2xl bg-white uppercase text-[10px] font-black outline-none border" value={s.tema} onChange={e => { const ns=[...sched]; ns[i].tema=e.target.value.toUpperCase(); setSched(ns); }} /></div>
                                        <div className="italic font-black font-black"><label className="text-[8px] uppercase text-slate-400 block mb-1 font-black">Fecha</label><input className="w-full p-4 rounded-2xl bg-white text-center text-[10px] font-black outline-none border" value={s.fecha} onChange={e => { const ns=[...sched]; ns[i].fecha=e.target.value.toUpperCase(); setSched(ns); }} /></div>
                                        <div className="italic font-black font-black"><label className="text-[8px] uppercase text-slate-400 block mb-1 font-black font-black">Hora</label><input className="w-full p-4 rounded-2xl bg-white text-center text-[10px] font-black outline-none border" value={s.hora} onChange={e => { const ns=[...sched]; ns[i].hora=e.target.value.toUpperCase(); setSched(ns); }} /></div>
                                        <div className="italic font-black font-black"><label className="text-[8px] uppercase text-slate-400 block mb-1 font-black font-black">Lugar</label><input className="w-full p-4 rounded-2xl bg-white text-center text-[10px] font-black outline-none border" value={s.lugar} onChange={e => { const ns=[...sched]; ns[i].lugar=e.target.value.toUpperCase(); setSched(ns); }} /></div>
                                        <div className="flex items-end font-black font-black font-black font-black font-black"><button onClick={() => setSched(sched.filter(x => x.id !== s.id))} className="w-full h-14 bg-rose-50 text-rose-500 rounded-2xl font-black font-black">‚úï</button></div>
                                    </div>
                                ))}
                            </div>
                            <button onClick={() => onUpdateSchedule(sched)} className="mt-14 w-full bg-slate-900 text-white font-black py-8 rounded-[2.5rem] uppercase tracking-widest text-[11px] shadow-2xl italic font-black font-black font-black font-black font-black font-black">ACTUALIZAR EL PROGRAMA DE PLATICAS EDUCATVAS DE MED.PREV. DEL HGSC EN LOS CELULARES</button>
                        </div>
                    )}
                </div>
            );
        }

        function PrintableCarnet({ data, schedule }) {
            if (!data) return null;
            return (
                <div className="bg-white font-black">
                    <div className="print-page font-black">
                        <div className="print-half font-black">
                            <div className="print-border-frame"><div className="print-header-bar mb-6 font-black">Informaci√≥n del Hospital</div>
                                <div className="flex-grow flex flex-col items-center justify-center text-center p-4 font-black">
                                    <div className="w-full border-2 border-slate-100 rounded-3xl p-6 bg-slate-50 font-black mb-6"><p className="text-[10px] uppercase text-rose-600 mb-1 italic font-black font-black font-black font-black">Tel√©fono de Citas</p><p className="text-3xl font-black font-black">971-71-49000</p><div className="bg-slate-900 text-white text-xs px-8 py-2 rounded-full mt-4 inline-block font-black font-black">EXT. 52-414</div></div>
                                    <HospitalLogoSVG size="w-24 h-24 mb-4" /><p className="text-sm font-black uppercase tracking-widest leading-tight">Hospital General Salina Cruz</p><p className="text-[10px] opacity-60 uppercase italic font-black font-black">Medicina Preventiva</p>
                                    <div className="mt-8 text-center font-black"><p className="text-teal-600 text-[10px] uppercase font-black font-black">üìç Direcci√≥n:</p><p className="text-xs font-bold text-slate-500 font-black font-black">Francisco Villa S/N, Col. Hidalgo Oriente, Salina Cruz, Oaxaca.</p></div>
                                </div>
                                <div className="mt-4 pt-3 border-t text-center text-[10px] font-black italic text-slate-400 uppercase tracking-widest font-black">"Mujer informada, embarazo seguro"</div>
                            </div>
                        </div>
                        <div className="print-half font-black"><div className="print-border-frame bg-slate-950 text-white font-black" style={{borderColor: '#ffffff'}}>
                                <p className="text-center text-xs font-black tracking-widest opacity-70 mb-10 font-black font-black font-black">CONTROL DIGITAL PEMEX</p>
                                <div className="flex flex-col items-center flex-grow font-black font-black">
                                    <LogoSVG size="w-40 h-40 mb-10 font-black font-black font-black font-black font-black font-black" />
                                    <h1 className="text-4xl font-black uppercase italic leading-none mb-4 font-black font-black font-black font-black font-black font-black">Club de<br/>Embarazadas</h1>
                                    <div className="h-2 w-24 bg-rose-600 rounded-full mb-10 font-black font-black font-black font-black font-black font-black font-black font-black"></div>
                                    <div className="w-full border-2 border-white/20 p-8 rounded-[2.5rem] bg-white/5 text-left font-black font-black">
                                        <p className="text-[10px] uppercase mb-2 italic text-teal-400 font-black font-black font-black">Derechohabiente</p><div className="text-xl font-black uppercase mb-6 border-b border-white/10 pb-4 font-black font-black font-black font-black font-black">{data.nombre}</div>
                                        <div className="grid grid-cols-2 gap-8 font-black font-black font-black font-black font-black font-black">
                                            <div><p className="text-[10px] uppercase italic text-teal-400 font-black font-black font-black font-black font-black">Ficha</p><p className="text-lg font-black tracking-widest font-black font-black font-black font-black font-black">{data.ficha}-{data.cod}</p></div>
                                            <div className="text-right font-black font-black font-black font-black font-black font-black"><p className="text-[10px] uppercase italic text-teal-400 font-black font-black font-black font-black font-black">Sangre</p><p className="text-lg font-black text-rose-500 font-black font-black font-black font-black font-black">{data.sangre || 'N/A'}</p></div>
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-8 text-center text-[10px] font-black text-teal-400 uppercase tracking-widest italic font-black font-black">HG Salina Cruz ‚Ä¢ Medicina Preventiva</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- COMPONENTE APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('login'); 
            const [loginFicha, setLoginFicha] = useState('');
            const [loginCod, setLoginCod] = useState('08');
            const [adminName, setAdminName] = useState('');
            const [loading, setLoading] = useState(true);
            const [patientData, setPatientData] = useState(null);
            const [globalSchedule, setGlobalSchedule] = useState([]);
            const [patientsList, setPatientsList] = useState([]);
            const [modal, setModal] = useState({ isOpen: false, type: 'success', title: '', message: '' });
            const [printData, setPrintData] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);
            const [isUpdatingGlobally, setIsUpdatingGlobally] = useState(false);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (u) => {
                    if (!u) { try { await signInAnonymously(auth); } catch (e) { console.error(e); } }
                    setUser(auth.currentUser);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubS = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'schedule'), (snap) => {
                    if (snap.exists()) setGlobalSchedule(snap.data().platicas || []);
                });
                const unsubP = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'patients'), (snap) => {
                    setPatientsList(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => { unsubS(); unsubP(); };
            }, [user]);

            useEffect(() => {
                if (printData) {
                    const timer = setTimeout(() => { window.print(); setPrintData(null); }, 1000);
                    return () => clearTimeout(timer);
                }
            }, [printData]);

            const handleAccess = async () => {
                const f = loginFicha.trim();
                if (!f) return;
                setLoading(true);
                if (loginCod === '00' && (f === '464896' || f === '451977')) {
                    setAdminName(f === '464896' ? "L.T.S ALEJANDRA TRINIDAD ORTIZ MARTINEZ" : "ADMINISTRADOR 451977");
                    setView('admin');
                    setLoading(false);
                    return;
                }
                try {
                    const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'patients', `${f}-${loginCod}`));
                    if (snap.exists()) { setPatientData(snap.data()); setView('patient'); }
                    else { setModal({ isOpen: true, type: 'error', title: 'No Encontrada', message: 'La ficha no est√° registrada.' }); }
                } catch (err) { console.error(err); }
                setLoading(false);
            };

            const savePatient = async (data) => {
                if (!data.ficha || !data.nombre) return false;
                setIsSyncing(true);
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'patients', `${data.ficha.trim()}-${data.cod}`), { ...data, updatedAt: new Date().toISOString() });
                    setModal({ isOpen: true, type: 'success', title: 'Sincronizado', message: 'Registro actualizado en la nube.' });
                    setIsSyncing(false);
                    return true;
                } catch (e) { setIsSyncing(false); return false; }
            };

            const deletePatient = async (id) => {
                if (confirm("¬øEliminar permanentemente?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'patients', id));
            };

            const updateGlobal = async (newList) => {
                setIsUpdatingGlobally(true);
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'schedule'), { platicas: newList });
                    setTimeout(() => { setIsUpdatingGlobally(false); setModal({ isOpen: true, type: 'success', title: '√âxito', message: 'Programa actualizado globalmente.' }); }, 2000);
                } catch (e) { setIsUpdatingGlobally(false); }
            };

            const toggleRubrica = async (pId, sId) => {
                const p = patientsList.find(x => x.id === pId);
                const asis = { ...(p.asistencias || {}) };
                asis[sId] = !asis[sId];
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'patients', pId), { asistencias: asis });
            };

            if (loading) return <div className="h-screen bg-slate-950 flex items-center justify-center text-white text-xs font-black uppercase tracking-widest animate-pulse font-black font-black font-black">Cargando...</div>;

            return (
                <div className="min-h-screen">
                    <SyncOverlay isVisible={isUpdatingGlobally} />
                    <Modal {...modal} onClose={() => setModal({...modal, isOpen: false})} />
                    {view === 'login' && <LoginView ficha={loginFicha} setFicha={setLoginFicha} cod={loginCod} setCod={setLoginCod} onAccess={handleAccess} />}
                    {view === 'patient' && <PatientBookView data={patientData} schedule={globalSchedule} onBack={() => setView('login')} />}
                    {view === 'admin' && <AdminView adminName={adminName} schedule={globalSchedule} patientsList={patientsList} onUpdateSchedule={updateGlobal} onSavePatient={savePatient} onDeletePatient={deletePatient} onToggleRubrica={toggleRubrica} onBack={() => setView('login')} onPrint={setPrintData} />}
                    <div className="print-only"><PrintableCarnet data={printData} schedule={globalSchedule} /></div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>